# ============================================================================
# PREFIX KEY CONFIGURATION
# ============================================================================

# Change prefix from C-b to C-s
unbind C-b
set -g prefix C-s
bind C-s send-prefix


# ============================================================================
# GENERAL BEHAVIOR
# ============================================================================

# Timing settings
set -sg escape-time 0                # No delay for escape key press
set -g repeat-time 300               # Time for repeatable commands
set -g history-limit 50000           # Scrollback buffer size

# Input and interaction
set -g mouse on                      # Enable mouse support
set -g focus-events on               # Send focus events to applications
set -g mode-keys vi                  # Vi-style keys in copy mode
set -g status-keys vi                # Vi-style keys in status line


# ============================================================================
# WINDOW AND PANE INDEXING
# ============================================================================

set -g base-index 1                  # Start window numbering at 1
setw -g pane-base-index 1            # Start pane numbering at 1
set -g renumber-windows on           # Renumber windows when one is closed
setw -g aggressive-resize on         # Resize based on smallest active client


# ============================================================================
# DISPLAY AND TERMINAL SETTINGS
# ============================================================================

# Terminal capabilities
set -g default-terminal "tmux-256color"
set -as terminal-features ",*:RGB"   # Enable true color support
set -gq allow-passthrough on         # Allow image rendering (image.nvim)

# Status bar position
set-option -g status-position top

# Display timing
set -g display-time 2000             # Message display duration (ms)
set -g display-panes-time 2000       # Pane number display duration (ms)
set -g status-interval 5             # Status bar refresh interval (seconds)

# Window title and activity
set -g set-titles off                # Don't set terminal title
set -g visual-activity off           # Don't show visual activity indicators
set -g visual-bell off               # Don't show visual bell
set -g monitor-activity on           # Monitor activity in windows

# ============================================================================
# KEY BINDINGS - CONFIGURATION
# ============================================================================

# Reload configuration
unbind r
bind r source-file ~/.tmux.conf \; display-message "Config reloaded!"

# Toggle status bar visibility
bind-key t set-option status


# ============================================================================
# KEY BINDINGS - WINDOWS
# ============================================================================

# Create new window with custom name prompt
bind-key c command-prompt -p "Window name:" "run-shell \"~/.tmux/scripts/new-window.sh '%%' '#{pane_current_path}'\""

# Navigate windows by number (Alt+1-9, no prefix needed)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Navigate windows with Shift+Arrow (no prefix needed)
bind -n S-Left previous-window
bind -n S-Right next-window

# Move windows left/right with Ctrl+Shift+Arrow (no prefix needed)
bind-key -n C-S-Left swap-window -t -1\; select-window -t -1
bind-key -n C-S-Right swap-window -t +1\; select-window -t +1

# ============================================================================
# KEY BINDINGS - PANES (CREATION AND SPLITS)
# ============================================================================

# Split panes with custom title prompts
bind-key | split-window -h -c "#{pane_current_path}" \; command-prompt -p "Pane title:" "select-pane -T '%%'"
bind-key - split-window -v -c "#{pane_current_path}" \; command-prompt -p "Pane title:" "select-pane -T '%%'"


# ============================================================================
# KEY BINDINGS - PANES (NAVIGATION)
# ============================================================================

# Navigate panes with prefix+hjkl
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# Navigate panes with Alt+hjkl (no prefix needed)
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R


# ============================================================================
# KEY BINDINGS - PANES (RESIZING)
# ============================================================================

# Resize panes with prefix+HJKL (capital letters)
bind-key H resize-pane -L 5
bind-key J resize-pane -D 5
bind-key K resize-pane -U 5
bind-key L resize-pane -R 5


# ============================================================================
# KEY BINDINGS - PANES (MANAGEMENT)
# ============================================================================

# Zoom/unzoom pane
bind-key z resize-pane -Z

# Kill panes and windows with confirmation
bind-key x confirm-before -p "Kill pane #P? (y/n)" kill-pane
bind-key X confirm-before -p "Kill window #W? (y/n)" kill-window
bind-key C-x confirm-before -p "Kill all other panes? (y/n)" "kill-pane -a"

# Layout management
bind-key Space next-layout
bind-key = select-layout even-horizontal
bind-key + select-layout even-vertical

# Mark and swap panes
bind-key m select-pane -m
bind-key M swap-pane
bind-key > swap-pane -D
bind-key < swap-pane -U

# Synchronize panes (send input to all panes in window)
bind-key C-s set-window-option synchronize-panes\; display-message "synchronize-panes: #{?pane_synchronized,ON,OFF}"

# Popup windows
bind-key g display-popup -E -w 80% -h 80%
bind-key G display-popup -E "tmux new-session -A -s scratch"

# ============================================================================
# KEY BINDINGS - SESSIONS
# ============================================================================

# Session management
bind-key S choose-session
bind-key w choose-tree -Zs
bind-key N command-prompt -p "New session:" "new-session -s '%%'"
bind-key R command-prompt -p "Rename session:" "rename-session '%%'"

# ============================================================================
# KEY BINDINGS - COPY MODE (VI-STYLE)
# ============================================================================

# Enter copy mode
bind-key v copy-mode
bind-key / copy-mode \; send-keys ?

# Paste from buffer
bind-key p paste-buffer

# Selection bindings in copy mode
unbind-key -T copy-mode-vi Space
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi V send-keys -X select-line
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle

# Copy to system clipboard (macOS)
if-shell "uname | grep -q Darwin" \
    "bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'pbcopy'; \
     bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel 'pbcopy'"

# Copy to system clipboard (Linux with xclip)
if-shell "uname | grep -q Linux && command -v xclip > /dev/null 2>&1" \
    "bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'xclip -in -selection clipboard'; \
     bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel 'xclip -in -selection clipboard'"

# Navigate panes while in copy mode
bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R

# Clear screen (must be defined after copy-mode bindings)
bind-key C-l send-keys 'C-l'

# ============================================================================
# PLUGIN MANAGER (TPM)
# ============================================================================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'


# ============================================================================
# PLUGINS - SESSION MANAGEMENT
# ============================================================================

set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# Resurrect settings
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-processes 'ssh psql mysql sqlite3 "~npm start" "~npm run dev"'

# Continuum settings (auto-save/restore)
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'


# ============================================================================
# PLUGINS - NAVIGATION AND UTILITIES
# ============================================================================

set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'tmux-plugins/tmux-logging'

# Fuzzy finder settings
set -g @tmux-fzf-launch-key 'C-f'


# ============================================================================
# PLUGIN INITIALIZATION
# ============================================================================

# Initialize TPM (keep this line at the very bottom of plugins section)
run '~/.tmux/plugins/tpm/tpm'

# ============================================================================
# THEME - MINIMALIST CATPPUCCIN
# ============================================================================

# Catppuccin Mocha colors
%hidden MOCHA_ROSEWATER="#f5e0dc"
%hidden MOCHA_FLAMINGO="#f2cdcd"
%hidden MOCHA_PINK="#f5c2e7"
%hidden MOCHA_MAUVE="#cba6f7"
%hidden MOCHA_RED="#f38ba8"
%hidden MOCHA_MAROON="#eba0ac"
%hidden MOCHA_PEACH="#fab387"
%hidden MOCHA_YELLOW="#f9e2af"
%hidden MOCHA_GREEN="#a6e3a1"
%hidden MOCHA_TEAL="#94e2d5"
%hidden MOCHA_SKY="#89dceb"
%hidden MOCHA_SAPPHIRE="#74c7ec"
%hidden MOCHA_BLUE="#89b4fa"
%hidden MOCHA_LAVENDER="#b4befe"
%hidden MOCHA_TEXT="#cdd6f4"
%hidden MOCHA_SUBTEXT1="#bac2de"
%hidden MOCHA_SUBTEXT0="#a6adc8"
%hidden MOCHA_OVERLAY2="#9399b2"
%hidden MOCHA_OVERLAY1="#7f849c"
%hidden MOCHA_OVERLAY0="#6c7086"
%hidden MOCHA_SURFACE2="#585b70"
%hidden MOCHA_SURFACE1="#45475a"
%hidden MOCHA_SURFACE0="#313244"
%hidden MOCHA_BASE="#1e1e2e"
%hidden MOCHA_MANTLE="#181825"
%hidden MOCHA_CRUST="#11111b"

# Status bar styling - transparent background
set -g status-style "bg=default,fg=#{MOCHA_TEXT}"

# ============================================================================
# STATUS BAR CONFIGURATION
# ============================================================================

# Status bar dimensions
set -g status-right-length 150
set -g status-left-length 100

# Left status - empty
set -g status-left ""

# Window status - minimalist style (no backgrounds)
set -g window-status-format "#[bg=default,fg=#{MOCHA_OVERLAY1}]#I #W"
set -g window-status-current-format "#[bg=default,fg=#{MOCHA_BLUE},bold]#I #[bg=default,fg=#{MOCHA_LAVENDER}]#W"
set -g window-status-current-style "bg=default"
set -g window-status-style "bg=default"
set -g window-status-activity-style "bg=default,fg=#{MOCHA_YELLOW}"
set -g window-status-separator "  "

# Right status - minimalist with icons and colored text
# Format: application │ cpu │ session │ uptime │ battery │ time
set -g status-right "\
#[fg=#{MOCHA_MAUVE}] #{pane_current_command} \
#[fg=#{MOCHA_OVERLAY0}]│ \
#[fg=#{MOCHA_PEACH}]󰻠 #{cpu_percentage} \
#[fg=#{MOCHA_OVERLAY0}]│ \
#[fg=#{MOCHA_GREEN}]󰣇 #S \
#[fg=#{MOCHA_OVERLAY0}]│ \
#[fg=#{MOCHA_SAPPHIRE}]󱑎 #(uptime | sed 's/.*up *//' | sed 's/,.*//' | sed 's/  */ /g') \
#[fg=#{MOCHA_OVERLAY0}]│ \
#[fg=#{MOCHA_YELLOW}]#{battery_icon} #{battery_percentage} \
#[fg=#{MOCHA_OVERLAY0}]│ \
#[fg=#{MOCHA_SUBTEXT1}] %I:%M %p"

# Load status bar modules (for cpu and battery)
run ~/.config/tmux/plugins/tmux-plugins/tmux-cpu/cpu.tmux
run ~/.config/tmux/plugins/tmux-plugins/tmux-battery/battery.tmux

# ============================================================================
# WINDOW NAMING BEHAVIOR
# ============================================================================
# NOTE: These settings must come after plugins to prevent being overridden

# Preserve manual window names
setw -g automatic-rename off
set-option -g allow-rename off
